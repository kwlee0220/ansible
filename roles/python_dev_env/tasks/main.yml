---
- name: Ensure base build dependencies (Ubuntu 22.04)
  apt:
    name:
      - build-essential
      - curl
      - git
      - libbz2-dev
      - libreadline-dev
      - libssl-dev
      - libsqlite3-dev
      - zlib1g-dev
      - libffi-dev
      - liblzma-dev
      - tk-dev
      - python3
      - python3-venv
      - python3-pip
    state: present
    update_cache: yes
  become: yes

# --------------------
# pyenv 설치
# --------------------

- name: Check if pyenv is already installed
  stat:
    path: "{{ pyenv_root }}/bin/pyenv"
  register: pyenv_bin

- name: Install pyenv using official installer
  shell: |
    curl https://pyenv.run | bash
  args:
    executable: /bin/bash
  become: yes
  become_user: "{{ ansible_user_id }}"
  environment:
    HOME: "{{ python_dev_home }}"
  when: not pyenv_bin.stat.exists

- name: Define pyenv init block
  set_fact:
    pyenv_init_block: |
      export PYENV_ROOT="$HOME/.pyenv"
      export PATH="$PYENV_ROOT/bin:$PATH"
      eval "$(pyenv init -)"
      eval "$(pyenv virtualenv-init -)"

- name: Insert pyenv init block into shell rc files
  blockinfile:
    path: "{{ item }}"
    block: "{{ pyenv_init_block }}"
    create: yes
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: "0644"
    marker: "# {mark} ANSIBLE MANAGED BLOCK: pyenv"
  loop: "{{ python_dev_shell_rc_files }}"
  become: yes

# --------------------
# pyenv Python 설치
# --------------------

- name: Install requested Python versions via pyenv
  shell: |
    export PYENV_ROOT="$HOME/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
    for v in {{ pyenv_python_versions | join(' ') }}; do
      if ! pyenv versions --bare | grep -qx "$v"; then
        pyenv install "$v"
      fi
    done
  args:
    executable: /bin/bash
  become: yes
  become_user: "{{ ansible_user_id }}"
  environment:
    HOME: "{{ python_dev_home }}"
  when: pyenv_python_versions | length > 0

- name: Set pyenv global version
  shell: |
    export PYENV_ROOT="$HOME/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"
    pyenv global {{ pyenv_global_version }}
  args:
    executable: /bin/bash
  become: yes
  become_user: "{{ ansible_user_id }}"
  environment:
    HOME: "{{ python_dev_home }}"
  when: pyenv_global_version | length > 0

# --------------------
# Poetry 설치
# --------------------

- name: Check if Poetry installed
  stat:
    path: "{{ python_dev_home }}/.local/bin/poetry"
  register: poetry_bin
  when: poetry_install

- name: Install Poetry
  shell: |
    {% if poetry_version | length > 0 %}
    curl -sSL https://install.python-poetry.org | python3 - --version {{ poetry_version }}
    {% else %}
    curl -sSL https://install.python-poetry.org | python3 -
    {% endif %}
  args:
    executable: /bin/bash
  become: yes
  become_user: "{{ ansible_user_id }}"
  environment:
    HOME: "{{ python_dev_home }}"
  when: poetry_install and not poetry_bin.stat.exists

- name: Ensure ~/.local/bin is in PATH
  blockinfile:
    path: "{{ item }}"
    block: |
      export PATH="$HOME/.local/bin:$PATH"
    create: yes
    owner: "{{ ansible_user_id }}"
    group: "{{ ansible_user_id }}"
    mode: "0644"
    marker: "# {mark} ANSIBLE MANAGED BLOCK: poetry PATH"
  loop: "{{ python_dev_shell_rc_files }}"
  become: yes
  when: poetry_install

- name: Enable Poetry in-project virtualenv
  shell: |
    export PATH="$HOME/.local/bin:$PATH"
    {{ python_dev_home }}/.local/bin/poetry config virtualenvs.in-project true
  args:
    executable: /bin/bash
  become: yes
  become_user: "{{ ansible_user_id }}"
  environment:
    HOME: "{{ python_dev_home }}"
    PATH: "{{ python_dev_home }}/.local/bin:{{ ansible_env.PATH }}"
  when: poetry_install and poetry_enable_in_project_venv and poetry_bin.stat.exists