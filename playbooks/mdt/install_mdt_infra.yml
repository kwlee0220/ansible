---
- name: install necessary softwares for MDT platform
  hosts: all
  vars_files:
    - vars/mdt_vars.yml

  pre_tasks:
    - name: Install dconf-cli, dconf editor
      package:
        name:
          - gnome-tweaks
          - dconf-cli
          - dconf-editor
          - dbus-x11
        update_cache: true
        state: present
      become: true

    - name: Install psutil via apt (Ubuntu 22.04+)
      apt:
        name: python3-psutil
      become: true

  roles:
    - role: allow_sudo
    - role: basic_apps
    - role: temurin_jdk
    - role: gradle

    - role: fonts-d2coding
    - role: hangul
    - role: tilix
    - role: gnome-terminal
    - role: google-chrome
    - role: vscode
    - role: docker

    - name: Install PostgreSQL
      role: postgresql
      vars:
        postgres_version: 16
      when: install_postgresql | default(true) | bool

    - name: Create PostgreSQL user for MDTPlatform internal data
      role: postgresql_user
      vars:
        postgres_user: "{{ mdt_postgres_user }}"
        postgres_password: "{{ mdt_postgres_password }}"
      when: install_postgresql | default(true) | bool

    - name: Create PostgreSQL database for MDTPlatform internal data
      role: postgresql_db
      vars:
        postgres_db: "{{ mdt_postgres_db }}"
        postgres_user: "{{ mdt_postgres_user }}"
        postgres_password: "{{ mdt_postgres_password }}"
      when: install_postgresql | default(true) | bool

    - name: Install pgAdmin4
      role: pgadmin4
      when: install_postgresql | default(true) | bool

    - name: Install Mosquitto
      role: mosquitto
      when: install_mosquitto | default(true) | bool

    - role: single_argo_workflow
      when: install_argo_workflow | default(true) | bool

    - name: Install ROS2
      role: ros2
      when: install_ros2 | default(false) | bool

    - name: Install ROS 2 MoveIt
      role: ros-humble-moveit
      when: install_ros2 | default(false) | bool

    - name: Install NodeRED
      role: nodered
      when: install_nodered | default(false) | bool

  tasks:
    - name: python3-pip 설치
      package:
        name:
          - python3-pip
        state: present
      become: true

    - name: Install PCManFM 
      package:
        name:
          - pcmanfm
      become: true

    - name: Add postgres IP entry to /etc/hosts if not present
      blockinfile:
        path: /etc/hosts
        prepend_newline: yes
        append_newline: yes
        insertbefore: "# The following lines are desirable for IPv6 capable hosts"
        marker: "# POSTGRES: {mark}"
        block: |
          127.0.0.1       postgres
      become: true
      when: install_postgresql | default(true) | bool

    - name: Add MQTT IP entry to /etc/hosts if not present
      blockinfile:
        path: /etc/hosts
        prepend_newline: yes
        append_newline: yes
        insertbefore: "# The following lines are desirable for IPv6 capable hosts"
        marker: "# MQTT: {mark}"
        block: |
          127.0.0.1       mqtt_broker
      become: true
      when: install_mosquitto | default(true) | bool

- import_playbook: "../linux/samba/add_samba_client_share.yml"
